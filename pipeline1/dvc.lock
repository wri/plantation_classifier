schema: '2.0'
stages:
  prep_features:
    cmd: python src/stage_prep_features.py --params=params.yaml
    deps:
    - path: src/features/create_xy.py
      hash: md5
      md5: aa528a3f0d0ead8d8c0382dcc6ae8b83
      size: 19581
    - path: src/stage_prep_features.py
      hash: md5
      md5: df89990fe6f2b8487c7c538566d855af
      size: 3620
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          select_features: false
          selected_features: data/train/selected_features.json
          classes: 4
          ard_subsample: 4
          subset_fraction: 1.0
          test_split: 20
          train_split: 80
          val_split: 25
          X_train: data/train/X_train.pkl
          y_train: data/train/y_train.pkl
          X_test: data/train/X_test.pkl
          y_test: data/train/y_test.pkl
        data_load:
          download_data: false
          bucket_name: restoration-monitoring
          folder_prefix: plantation-mapping/data/train/
          local_prefix: data/
          ceo_survey:
          - v08
          - v14
          - v15
          - v18
          - v19
          - v20
          data_prefix_list:
          - slope
          - s1
          - s2
          - dem
          - features-ckpt-2023-02-09
          - labels
          - ard
          - features-ard
        train:
          model_name: model
          perform_fs: true
          tune_hyperparams: false
          max_features: 40
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            rfc:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            svm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            lgbm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            xgb:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            logreg:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            cat:
              importance_metric: shap
              use_class_weights: true
              use_defaults: true
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
          model_dir: models/
    outs:
    - path: data/train/X_test.pkl
      hash: md5
      md5: 46255539b2ba25b3921ef8560484d8c0
      size: 21372002
    - path: data/train/X_train.pkl
      hash: md5
      md5: 1dd094349bd3c606c0738f29b5217c73
      size: 85192740
    - path: data/train/y_test.pkl
      hash: md5
      md5: 47c71ab90767b6a2052bb98c3c40e137
      size: 227520
    - path: data/train/y_train.pkl
      hash: md5
      md5: a744c0a380a78a4ce447aaffa88c0371
      size: 906466
  train_model:
    cmd: python src/stage_train_model.py --params=params.yaml
    deps:
    - path: data/train/X_test.pkl
      hash: md5
      md5: 46255539b2ba25b3921ef8560484d8c0
      size: 21372002
    - path: data/train/X_train.pkl
      hash: md5
      md5: 1dd094349bd3c606c0738f29b5217c73
      size: 85192740
    - path: data/train/y_test.pkl
      hash: md5
      md5: 47c71ab90767b6a2052bb98c3c40e137
      size: 227520
    - path: data/train/y_train.pkl
      hash: md5
      md5: a744c0a380a78a4ce447aaffa88c0371
      size: 906466
    - path: src/model/feature_selection.py
      hash: md5
      md5: f62b424d638dd0315350a9eae48fa411
      size: 5891
    - path: src/model/train.py
      hash: md5
      md5: 03f0c51f66bb7a3166b14dd1dddb02e4
      size: 3457
    - path: src/model/tune.py
      hash: md5
      md5: 5e9ff152307b80a13df7d79814c58cfc
      size: 4057
    - path: src/stage_train_model.py
      hash: md5
      md5: 96ce3edf71d8790950f8e4233519fc4c
      size: 6855
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          select_features: false
          selected_features: data/train/selected_features.json
          classes: 4
          ard_subsample: 4
          subset_fraction: 1.0
          test_split: 20
          train_split: 80
          val_split: 25
          X_train: data/train/X_train.pkl
          y_train: data/train/y_train.pkl
          X_test: data/train/X_test.pkl
          y_test: data/train/y_test.pkl
        train:
          model_name: model
          perform_fs: true
          tune_hyperparams: false
          max_features: 40
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            rfc:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            svm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            lgbm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            xgb:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            logreg:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            cat:
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
          model_dir: models/
        tune:
          estimator_name: cat
          n_iter: 30
          cv: 3
          plot: false
          verbose: false
          estimators:
            cat:
              param_grid:
                iter_min: 500
                iter_max: 1200
                iter_step: 10
                depth_min: 4
                depth_max: 10
                depth_step: 4
                12_leaf_min: 2
                12_leaf_max: 30
                12_leaf_step: 4
                min_data_leaf_min: 20
                min_data_leaf_max: 100
                min_data_leaf_step: 3
                learn_rate:
                - 0.02
                - 0.03
                - 0.04
          best_params: src/evaluation/best_params.json
    outs:
    - path: data/train/selected_features.json
      hash: md5
      md5: 9f5547c879aef9d45c3a05d1c321c31b
      size: 194
    - path: models/model.joblib
      hash: md5
      md5: d83f6f0ead18f246f39755b31e176d84
      size: 2644434
    - path: src/evaluation/best_params.json
      hash: md5
      md5: 99914b932bd37a50b983c5e7c90ae93b
      size: 2
  evaluate_model:
    cmd: python src/stage_evaluate_model.py --params=params.yaml
    deps:
    - path: data/train/X_test.pkl
      hash: md5
      md5: 46255539b2ba25b3921ef8560484d8c0
      size: 21372002
    - path: data/train/y_test.pkl
      hash: md5
      md5: 47c71ab90767b6a2052bb98c3c40e137
      size: 227520
    - path: models/model.joblib
      hash: md5
      md5: d83f6f0ead18f246f39755b31e176d84
      size: 2644434
    - path: src/evaluation/validation_visuals.py
      hash: md5
      md5: 03c3bd6638b24739b369000fefd1fdfd
      size: 2913
    - path: src/stage_evaluate_model.py
      hash: md5
      md5: 44354bb57ad3446cb81f8a3e0afc7970
      size: 4120
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          select_features: false
          selected_features: data/train/selected_features.json
          classes: 4
          ard_subsample: 4
          subset_fraction: 1.0
          test_split: 20
          train_split: 80
          val_split: 25
          X_train: data/train/X_train.pkl
          y_train: data/train/y_train.pkl
          X_test: data/train/X_test.pkl
          y_test: data/train/y_test.pkl
        evaluate:
          metrics_file: src/evaluation/metrics.json
          confusion_matrix_image: src/evaluation/confusion_matrix.png
          confusion_matrix_data: src/evaluation/confusion_matrix_data.csv
          tile_id_loc: data
          tile_s3_bucket: tof-output
        train:
          model_name: model
          perform_fs: true
          tune_hyperparams: false
          max_features: 40
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            rfc:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            svm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            lgbm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            xgb:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            logreg:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            cat:
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
          model_dir: models/
    outs:
    - path: src/evaluation/confusion_matrix.png
      hash: md5
      md5: cba26732bae75e0c804e15b1a0377ee5
      size: 27633
    - path: src/evaluation/confusion_matrix_data.csv
      hash: md5
      md5: f3ecc8a5fd8b13e5814484b0c1d728b9
      size: 113697
    - path: src/evaluation/metrics.json
      hash: md5
      md5: 5c876a58eb143d69daa82d6f3402c6f1
      size: 192
  load_data:
    cmd: python ../src/stage_load_data.py --params=../params.yaml
    deps:
    - path: ../src/stage_load_data.py
      hash: md5
      md5: b5e6602d43707febb306aa8608238ba1
      size: 1050
    params:
      ../params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_load:
          download_data: false
          bucket_name: restoration-monitoring
          folder_prefix: plantation-mapping/data/train/
          local_prefix: data/
          ceo_survey:
          - v08
          - v14
          - v15
          - v18
          - v19
          - v20
          data_prefix_list:
          - slope
          - s1
          - s2
          - dem
          - features-ckpt-2023-02-09
          - labels
          - ard
          - features-ard
