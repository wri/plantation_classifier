stages:
  # load_data:
  #   cmd: python src/stage_load_data.py --params=params.yaml
  #   deps:
  #     - src/stage_load_data.py
  #   params:
  #     - base
  #     - data_load

  prep_features:
    cmd: python src/stage_prep_features.py --params=params.yaml
    deps:
      - src/features/create_xy.py
      - src/stage_prep_features.py
    params:
      - base
      - data_load
      - data_condition
      - train
    outs:
      - data/train/X_train.pkl
      - data/train/X_test.pkl
      - data/train/y_train.pkl
      - data/train/y_test.pkl

  select_features:
    cmd: python src/stage_select_features.py --params=params.yaml
    deps:
      - data/train/X_train.pkl
      - data/train/X_test.pkl
      - data/train/y_train.pkl
      - data/train/y_test.pkl
      - src/model/feature_selection.py
      - src/model/train.py
      - src/stage_select_features.py
    params:
      - base
      - data_condition
      - train
    outs:
      - data/train/selected_features.json

  tune_hyperparameters:
    cmd: python src/stage_tune_hyperparameters.py --params=params.yaml
    deps:
      - data/train/X_train.pkl
      - data/train/X_test.pkl
      - data/train/y_train.pkl
      - data/train/y_test.pkl
      - data/train/selected_features.json
      - src/model/train.py
      - src/model/tune.py
      - src/stage_tune_hyperparameters.py
    params:
      - base
      - data_condition
      - train
      - tune
    outs:
      - src/evaluation/best_params.json

  train_model:
    cmd: python src/stage_train_model.py --params=params.yaml
    deps:
      - data/train/X_train.pkl
      - data/train/X_test.pkl
      - data/train/y_train.pkl
      - data/train/y_test.pkl
      - src/model/train.py
      - src/stage_train_model.py
      - data/train/selected_features.json
      - src/evaluation/best_params.json
    params:
      - base
      - data_condition
      - train
      - tune
    outs:
      - models/model.joblib

  evaluate_model:
    cmd: python src/stage_evaluate_model.py --params=params.yaml
    deps:
      - data/train/X_test.pkl
      - data/train/y_test.pkl
      - models/model.joblib
      - src/evaluation/validation_visuals.py
      - src/stage_evaluate_model.py
    params:
      - base
      - data_condition
      - train
      - evaluate
    metrics:
      - src/evaluation/metrics.json
      #cache: false  # keep as part of git history

    plots:
      - src/evaluation/confusion_matrix.png
      - src/evaluation/confusion_matrix_data.csv:
          template: confusion_normalized
          x: predicted
          y: y_true
