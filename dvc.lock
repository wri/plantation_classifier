schema: '2.0'
stages:
  prep_features:
    cmd: python src/stage_prep_features.py --params=params.yaml
    deps:
    - path: src/features/PlantationsData.py
      hash: md5
      md5: 5ccdfb18e0355ffb4181be416f140184
      size: 3497
    - path: src/features/create_xy.py
      hash: md5
      md5: e94a33399cd50473e8f23058baea7a1f
      size: 14618
    - path: src/stage_prep_features.py
      hash: md5
      md5: 306200dc3ff169636bad47afbea0639d
      size: 2233
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        data_load:
          download_data: false
          bucket_name: restoration-monitoring
          folder_prefix: plantation-mapping/data/train/
          local_prefix: data/
          ceo_survey:
          - v08
          - v14
          - v15
          - v18
          - v19
          - v20
          data_prefix_list:
          - slope
          - s1
          - s2
          - dem
          - features-ckpt-2023-02-09
          - labels
          - ard
          - features-ard
    outs:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 0bfaa54bd9cd96ad67ea6d606d4167fe
      size: 429665013
  load_data:
    cmd: python src/stage_load_data.py --params=params.yaml
    deps:
    - path: src/stage_load_data.py
      hash: md5
      md5: b5e6602d43707febb306aa8608238ba1
      size: 1050
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_load:
          download_data: false
          bucket_name: restoration-monitoring
          folder_prefix: plantation-mapping/data/train/
          local_prefix: data/
          ceo_survey:
          - v08
          - v14
          - v15
          - v18
          - v19
          - v20
          data_prefix_list:
          - slope
          - s1
          - s2
          - dem
          - features-ckpt-2023-02-09
          - labels
          - ard
          - features-ard
  select_features_hyperparams:
    cmd: python src/stage_select_and_tune.py --params=params.yaml
    deps:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 0bfaa54bd9cd96ad67ea6d606d4167fe
      size: 429665013
    - path: src/features/feature_selection.py
      hash: md5
      md5: 9505963ba70f0fb7e724e09300456a57
      size: 5625
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        select:
          select_features: true
          selected_features_path: data/train/selected_features.json
          max_features: 80
          fs_analysis: shap
        train:
          use_best_params: false
          model_dir: models/
          model_name: models/model.joblib
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            cat:
              importance_metric: shap
              use_class_weights: true
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
        tune:
          tune_hyperparameters: false
          n_iter: 20
          plot: false
          verbose: false
          estimators:
            cat:
              param_grid:
                iter_min: 700
                iter_max: 900
                iter_step: 2
                depth_min: 6
                depth_max: 12
                depth_step: 3
                leaf_reg_min: 2
                leaf_reg_max: 30
                leaf_reg_step: 3
                min_data_leaf_min: 20
                min_data_leaf_max: 100
                min_data_leaf_step: 3
                learn_rate:
                - 0.02
                - 0.03
                - 0.04
          best_params: src/evaluation/best_params.json
    outs:
    - path: data/train/selected_features.json
      hash: md5
      md5: dee24b82f7bbb9179b819705d0fa492a
      size: 358
    - path: src/evaluation/best_params.json
      hash: md5
      md5: cf78d06c4e033cebed6e025682b56c0f
      size: 110
  train_model:
    cmd: python src/stage_train_model.py --params=params.yaml
    deps:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 0bfaa54bd9cd96ad67ea6d606d4167fe
      size: 429665013
    - path: data/train/selected_features.json
      hash: md5
      md5: dee24b82f7bbb9179b819705d0fa492a
      size: 358
    - path: src/evaluation/best_params.json
      hash: md5
      md5: cf78d06c4e033cebed6e025682b56c0f
      size: 110
    - path: src/model/train.py
      hash: md5
      md5: 3b8af3616962af8636a74d7dc406c446
      size: 3384
    - path: src/stage_train_model.py
      hash: md5
      md5: 90844da15eba7064949e73eba9ccdcb4
      size: 2237
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        train:
          use_best_params: false
          model_dir: models/
          model_name: models/model.joblib
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            cat:
              importance_metric: shap
              use_class_weights: true
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
    outs:
    - path: models/model.joblib
      hash: md5
      md5: bb2c0db714627fa3f3aa78bcd71a6e89
      size: 2644357
  evaluate_model:
    cmd: python src/stage_evaluate_model.py --params=params.yaml
    deps:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 0bfaa54bd9cd96ad67ea6d606d4167fe
      size: 429665013
    - path: data/train/selected_features.json
      hash: md5
      md5: dee24b82f7bbb9179b819705d0fa492a
      size: 358
    - path: models/model.joblib
      hash: md5
      md5: bb2c0db714627fa3f3aa78bcd71a6e89
      size: 2644357
    - path: src/evaluation/best_params.json
      hash: md5
      md5: cf78d06c4e033cebed6e025682b56c0f
      size: 110
    - path: src/evaluation/validation_visuals.py
      hash: md5
      md5: 03c3bd6638b24739b369000fefd1fdfd
      size: 2913
    - path: src/stage_evaluate_model.py
      hash: md5
      md5: 4e131cd8c94b463942ca90fc0213b4d1
      size: 4469
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        evaluate:
          metrics_file: src/evaluation/metrics
          cm_image: src/evaluation/confusion_matrix
          cm_data: src/evaluation/confusion_matrix_data
          tile_id_loc: data
        train:
          use_best_params: false
          model_dir: models/
          model_name: models/model.joblib
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            cat:
              importance_metric: shap
              use_class_weights: true
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
    outs:
    - path: src/evaluation/confusion_matrix.png
      hash: md5
      md5: 39c2db5eadfb4828ede2493ea96aecaa
      size: 31521
    - path: src/evaluation/confusion_matrix_data.csv
      hash: md5
      md5: b48aa4a59a52892238fa6ccfb083df9c
      size: 113697
    - path: src/evaluation/metrics.json
      hash: md5
      md5: 24c8e86a7374a4a827f8a3c32bfca861
      size: 192
