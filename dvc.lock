schema: '2.0'
stages:
  prep_features:
    cmd: python src/stage_prep_features.py --params=params.yaml
    deps:
    - path: src/features/PlantationsData.py
      hash: md5
      md5: 5ccdfb18e0355ffb4181be416f140184
      size: 3497
    - path: src/features/create_xy.py
      hash: md5
      md5: e94a33399cd50473e8f23058baea7a1f
      size: 14618
    - path: src/stage_prep_features.py
      hash: md5
      md5: 306200dc3ff169636bad47afbea0639d
      size: 2233
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        data_load:
          download_data: false
          bucket_name: restoration-monitoring
          folder_prefix: plantation-mapping/data/train/
          local_prefix: data/
          ceo_survey:
          - v08
          - v14
          - v15
          - v18
          - v19
          - v20
          data_prefix_list:
          - slope
          - s1
          - s2
          - dem
          - features-ckpt-2023-02-09
          - labels
          - ard
          - features-ard
    outs:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 94dfe6195841699ca97de4471224f257
      size: 429665996
  load_data:
    cmd: python src/stage_load_data.py --params=params.yaml
    deps:
    - path: src/stage_load_data.py
      hash: md5
      md5: b5e6602d43707febb306aa8608238ba1
      size: 1050
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_load:
          download_data: false
          bucket_name: restoration-monitoring
          folder_prefix: plantation-mapping/data/train/
          local_prefix: data/
          ceo_survey:
          - v08
          - v14
          - v15
          - v18
          - v19
          - v20
          data_prefix_list:
          - slope
          - s1
          - s2
          - dem
          - features-ckpt-2023-02-09
          - labels
          - ard
          - features-ard
  select_features_hyperparams:
    cmd: python src/stage_select_and_tune.py --params=params.yaml
    deps:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 94dfe6195841699ca97de4471224f257
      size: 429665996
    - path: src/features/feature_selection.py
      hash: md5
      md5: ec4631127d9c9a6120fd58f584f5e481
      size: 5823
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        select:
          select_features: false
          selected_features_path: data/train/selected_features.json
          max_features: 40
          fs_analysis: feat_imp
        train:
          use_best_params: false
          model_dir: models/
          model_name: models/model.joblib
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            rfc:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            svm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            lgbm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            xgb:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            logreg:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            cat:
              importance_metric: shap
              use_class_weights: true
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
                iterations: 811
        tune:
          tune_hyperparameters: false
          n_iter: 20
          cv: 3
          plot: false
          verbose: false
          estimators:
            cat:
              param_grid:
                iter_min: 700
                iter_max: 900
                iter_step: 2
                depth_min: 6
                depth_max: 12
                depth_step: 3
                leaf_reg_min: 2
                leaf_reg_max: 30
                leaf_reg_step: 3
                min_data_leaf_min: 20
                min_data_leaf_max: 100
                min_data_leaf_step: 3
                learn_rate:
                - 0.02
                - 0.03
                - 0.04
          best_params: src/evaluation/best_params.json
    outs:
    - path: data/train/selected_features.json
      hash: md5
      md5: 0e9fc4e5939b49c2e2cff51a1229c3fb
      size: 157
    - path: src/evaluation/best_params.json
      hash: md5
      md5: cf78d06c4e033cebed6e025682b56c0f
      size: 110
  train_model:
    cmd: python src/stage_train_model.py --params=params.yaml
    deps:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 94dfe6195841699ca97de4471224f257
      size: 429665996
    - path: data/train/selected_features.json
      hash: md5
      md5: 0e9fc4e5939b49c2e2cff51a1229c3fb
      size: 157
    - path: src/evaluation/best_params.json
      hash: md5
      md5: cf78d06c4e033cebed6e025682b56c0f
      size: 110
    - path: src/model/train.py
      hash: md5
      md5: 3b8af3616962af8636a74d7dc406c446
      size: 3384
    - path: src/stage_train_model.py
      hash: md5
      md5: 90844da15eba7064949e73eba9ccdcb4
      size: 2237
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        train:
          use_best_params: false
          model_dir: models/
          model_name: models/model.joblib
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            rfc:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            svm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            lgbm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            xgb:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            logreg:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            cat:
              importance_metric: shap
              use_class_weights: true
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
                iterations: 811
    outs:
    - path: models/model.joblib
      hash: md5
      md5: 9003f9660f2f922cb8fb66a53c97b708
      size: 2143465
  evaluate_model:
    cmd: python src/stage_evaluate_model.py --params=params.yaml
    deps:
    - path: data/train/modelData.pkl
      hash: md5
      md5: 94dfe6195841699ca97de4471224f257
      size: 429665996
    - path: data/train/selected_features.json
      hash: md5
      md5: 0e9fc4e5939b49c2e2cff51a1229c3fb
      size: 157
    - path: models/model.joblib
      hash: md5
      md5: 9003f9660f2f922cb8fb66a53c97b708
      size: 2143465
    - path: src/evaluation/best_params.json
      hash: md5
      md5: cf78d06c4e033cebed6e025682b56c0f
      size: 110
    - path: src/evaluation/validation_visuals.py
      hash: md5
      md5: 03c3bd6638b24739b369000fefd1fdfd
      size: 2913
    - path: src/stage_evaluate_model.py
      hash: md5
      md5: 4e131cd8c94b463942ca90fc0213b4d1
      size: 4469
    params:
      params.yaml:
        base:
          log_level: DEBUG
          random_state: 121
          config: config.yaml
        data_condition:
          classes: 4
          ard_subsample: 4
          subset_fraction: 0.1
          test_split: 20
          train_split: 80
          val_split: 25
          modelData_path: data/train/modelData.pkl
        evaluate:
          metrics_file: src/evaluation/metrics
          cm_image: src/evaluation/confusion_matrix
          cm_data: src/evaluation/confusion_matrix_data
          tile_id_loc: data
          tile_s3_bucket: tof-output
        train:
          use_best_params: false
          model_dir: models/
          model_name: models/model.joblib
          estimator_name: cat
          cv: 3
          tuning_metric: balanced_accuracy
          testing_metrics: accuracy balanced_accuracy precision recall f1 roc_auc
            log_loss
          estimators:
            rfc:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            svm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            lgbm:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            xgb:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            logreg:
              importance_metric: shap
              use_class_weights: true
              param_grid:
            cat:
              importance_metric: shap
              use_class_weights: true
              param_grid:
                loss_function: MultiClass
                random_state: 121
                logging_level: Silent
                iterations: 811
    outs:
    - path: src/evaluation/confusion_matrix.png
      hash: md5
      md5: 087f43ad2f5c548d86e6a66638cfa985
      size: 31056
    - path: src/evaluation/confusion_matrix_data.csv
      hash: md5
      md5: 7a96f7fdb872b5f67ff366510b8e7f32
      size: 113697
    - path: src/evaluation/metrics.json
      hash: md5
      md5: a54b169aa6c64e116eefdc27e29cc59f
      size: 192
